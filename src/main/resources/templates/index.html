<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>–ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞</title>
    <link href="/api/css/styles.css" rel="stylesheet">

</head>
<body class="main-page">
<div class="container main-container">
    <h1>–ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞</h1>

    <div class="user-info" id="userInfo">
        <h2>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
        <p><strong>Email:</strong> <span id="userEmail"></span></p>
        <div class="actions">
            <button class="btn btn-primary" onclick="window.location.href='/view/scooters'">
                üõ¥ –°–∞–º–æ–∫–∞—Ç–∏
            </button>
            <button class="btn btn-danger" onclick="logout()">–í–∏–π—Ç–∏</button>
        </div>
    </div>

    <div class="login-prompt" id="loginPrompt">
        <p>–ë—É–¥—å –ª–∞—Å–∫–∞, <a href="/api/view/login">—É–≤—ñ–π–¥—ñ—Ç—å</a> –∞–±–æ <a href="/api/view/registration">–∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å</a></p>
    </div>
</div>

<script>
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è JWT —Ç–æ–∫–µ–Ω—É
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            return null;
        }
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏—Ö–æ–¥—É
    function logout() {
        localStorage.removeItem('jwtToken');
        window.location.href = '/api/view/login';
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É –∑ JWT —Ç–æ–∫–µ–Ω–æ–º
    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('jwtToken');

        if (!token) {
            return null;
        }

        const headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };

        const response = await fetch(url, {
            ...options,
            headers
        });

        if (response.status === 401) {
            // –¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π –∞–±–æ –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è
            localStorage.removeItem('jwtToken');
            window.location.href = '/api/view/login';
            return null;
        }

        return response;
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ç–æ–∫–µ–Ω—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    window.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('jwtToken');

        if (!token) {
            document.getElementById('loginPrompt').classList.add('show');
            return;
        }

        // –î–µ–∫–æ–¥—É—î–º–æ —Ç–æ–∫–µ–Ω, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        const userData = parseJwt(token);

        if (userData) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –Ω–µ –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è —Ç–æ–∫–µ–Ω
            const currentTime = Math.floor(Date.now() / 1000);
            if (userData.exp && userData.exp < currentTime) {
                localStorage.removeItem('jwtToken');
                document.getElementById('loginPrompt').classList.add('show');
                return;
            }

            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            document.getElementById('userEmail').textContent = userData.sub || userData.email || 'N/A';
            document.getElementById('userInfo').classList.add('show');

        } else {
            document.getElementById('loginPrompt').classList.add('show');
        }
    });
</script>
</body>
</html>